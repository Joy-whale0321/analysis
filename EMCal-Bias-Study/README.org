#+title: EMCal Bias Study

* List of all databases
#+begin_src bash
psql -h sphnxdbmaster.sdcc.bnl.gov --list
#+end_src

* Extract EMCal Bias from Database
#+begin_src bash
psql -h sphnxdbmaster.sdcc.bnl.gov emcal -c "select *,cast(1000*(bias-66.5-2.5) as int) as gs from vop order by sector,ib,channel asc;" --csv > files/emcal-bias.csv
#+end_src

* EMCal Master Spreadsheet
https://docs.google.com/spreadsheets/d/1r8V_NYTaj0hXuvuMlxOB-5J2lB38dfHXbgemcb7WXKM/edit?usp=drive_link

* Read Bias macro
#+begin_src bash
make && ./bin/read-Bias files/emcal-bias.csv files/serial-to-sector.csv files/IB-channel-to-ADC-channel.csv files/EMCal-block-info.csv calibration/emcal_2024_prelim_calibration.root plots/EMCal-Info/plots.pdf files/vop.csv output/EMCal-block-info.root
#+end_src

* Write Bias macro
#+begin_src bash
make && ./bin/write-Bias files/emcal-bias.csv files/serial-to-sector.csv files/IB-channel-to-ADC-channel.csv scratch/bias-test
#+end_src

* Update Bias macro
#+begin_src bash
make && ./bin/update-Bias output/EMCal-block-info.root plots/bias-update-plots/plots.pdf
#+end_src
Alternatively
#+begin_src bash
root -b -l -q 'macros/update-Bias.C("output/EMCal-block-info.root","plots/bias-update/plots.pdf")'
#+end_src

* Update Offset macro
#+begin_src bash
make && ./bin/update-Offset output/EMCal-block-info.root plots/offset-update-plots/plots.pdf
#+end_src
Alternatively
#+begin_src bash
root -b -l -q 'macros/update-Offset.C("output/EMCal-block-info.root","plots/offset-update/plots.pdf")'
#+end_src

* Event Combiner
Combine a list of prdfs into one:
#+begin_src bash
xargs eventcombiner -vpfi calib-000[run]-0000.prdf < [prdf-list]
#+end_src

* Fun4All Quick Tests

** After editing Makefile.am
#+begin_src bash
rm -rf build && mkdir build && cd build && ../src/autogen.sh --prefix=$MYINSTALL && cd .. && make install -j8 --directory build && rm -f bin/Fun4All_Year2_Fitting && make && ./bin/Fun4All_Year2_Fitting data/calib-00057973-0000.prdf test.root 20 2>/dev/null
#+end_src

** After editing .cc or .h
#+begin_src bash
make install -j8 --directory build && rm -f bin/Fun4All_Year2_Fitting && make && ./bin/Fun4All_Year2_Fitting data/calib-00057973-0000.prdf test.root 20 2>/dev/null
#+end_src

*** With Pulser data
#+begin_src bash
make install -j8 --directory build && rm -f bin/Fun4All_Year2_Fitting && make && ./bin/Fun4All_Year2_Fitting pulser/data-00058514-0000.prdf test.root 20 1 2>/dev/null
#+end_src

* Display
Generate plots from the output of the Waveform Fitting results
#+begin_src bash
make && ./bin/display scratch/calo/test.list files/runs-gain-map-offsets.csv plots/ADC/plots.pdf
#+end_src
Alternatively:
#+begin_src bash
root -b -l -q 'macros/display.C("calo/test.list","files/runs-gain-map-offsets.csv","plots/ADC/plots.pdf")'
#+end_src

* Condor
** Resubmit Failed Jobs
#+begin_src bas
rg -vFf <(ls output | cut -d "-" -f2 | awk '{x=$0+0;print x}') jobs.list > resubmit.list
#+end_src
